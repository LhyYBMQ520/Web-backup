<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>哈基米之音（Hachimi Sound）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .content-auto {
      content-visibility: auto;
    }
    .grid-container {
      width: 100vw;
      height: calc(100vh - 12rem);
    }
    .grid-cell {
      position: relative;
      cursor: pointer;
      transition: background-color 0.2s ease;
      background-color: #f8fafc;
      border: 1px solid rgba(0, 0, 0, 0.05);
      user-select: none;
    }
    .grid-cell:hover {
      background-color: #f1f5f9;
    }
    .grid-cell:active, .grid-cell.active {
      background-color: #e2e8f0;
    }

    /* ---------- 缓冲界面样式 ---------- */
    #loading-screen {
      position: fixed;
      inset: 0;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.6s ease, visibility 0.6s ease;
    }

    #loading-screen.fade-out {
      opacity: 0;
      visibility: hidden;
    }

    .spinner {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #4f46e5;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-[#f8fafc] flex flex-col">
  <!-- ✅ 缓冲加载页面 -->
  <div id="loading-screen">
    <div class="spinner"></div>
    <p class="text-gray-600 text-lg mb-2">正在加载音频，请稍候...</p>
    <p id="progress-text" class="text-gray-500 text-sm">0 / 10</p>
  </div>

  <!-- 页面头部 -->
  <header class="py-6 px-4 text-center bg-white/80 backdrop-blur-sm shadow-sm">
    <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold bg-gradient-to-r from-[#4f46e5] to-[#60a5fa] bg-clip-text text-transparent mb-2">
      哈基米之音
    </h1>
    <p class="text-gray-500 max-w-md mx-auto">鼠标点击/触屏滑过格子播放声音</p>
  </header>

  <!-- 主体格子 -->
  <main class="flex-grow flex items-center justify-center">
    <div class="grid-container grid grid-cols-5 grid-rows-2">
      <div class="grid-cell" data-sound="1"></div>
      <div class="grid-cell" data-sound="2"></div>
      <div class="grid-cell" data-sound="3"></div>
      <div class="grid-cell" data-sound="4"></div>
      <div class="grid-cell" data-sound="5"></div>
      <div class="grid-cell" data-sound="6"></div>
      <div class="grid-cell" data-sound="7"></div>
      <div class="grid-cell" data-sound="8"></div>
      <div class="grid-cell" data-sound="9"></div>
      <div class="grid-cell" data-sound="10"></div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="py-4 px-4 text-center text-gray-500 text-sm border-t border-gray-100">
    <p>LC（Lcat）© 2025 哈基米之音</p>
  </footer>

  <!-- 音频资源 -->
  <div class="hidden">
    <audio id="sound-1" src="audio/曼波曼波，欧码吉利曼波.ogg" preload="auto"></audio>
    <audio id="sound-2" src="audio/哈基米哈基米哈基米.ogg" preload="auto"></audio>
    <audio id="sound-3" src="audio/哦南北绿豆.ogg" preload="auto"></audio>
    <audio id="sound-4" src="audio/WOW.ogg" preload="auto"></audio>
    <audio id="sound-5" src="audio/你哈牛魔啊.ogg" preload="auto"></audio>
    <audio id="sound-6" src="audio/阿米诺斯.ogg" preload="auto"></audio>
    <audio id="sound-7" src="audio/呵呵呵.ogg" preload="auto"></audio>
    <audio id="sound-8" src="audio/欧耶.ogg" preload="auto"></audio>
    <audio id="sound-9" src="audio/duang.ogg" preload="auto"></audio>
    <audio id="sound-10" src="audio/不给！.ogg" preload="auto"></audio>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const gridCells = document.querySelectorAll('.grid-cell');
    const audios = document.querySelectorAll('audio');
    const loadingScreen = document.getElementById('loading-screen');
    const progressText = document.getElementById('progress-text');
    let loadedCount = 0;
    const total = audios.length;

    // ✅ 更新进度文字
    function updateProgress() {
      progressText.textContent = `${loadedCount} / ${total}`;
    }

    // ✅ 音频加载检测（防止重复计数）
    audios.forEach(audio => {
      const markLoaded = () => {
        if (audio.dataset.loaded === "true") return; // 防止重复计数
        audio.dataset.loaded = "true";
        loadedCount++;
        updateProgress();
        if (loadedCount >= total) {
          setTimeout(() => {
            loadingScreen.classList.add('fade-out');
          }, 300);
        }
      };

      // 同时监听多种事件，但只统计一次
      ['canplaythrough', 'loadeddata', 'loadedmetadata'].forEach(evt => {
        audio.addEventListener(evt, markLoaded);
      });
      audio.addEventListener('error', () => {
        console.warn(`${audio.src} 加载失败`);
        markLoaded(); // 即使失败也计数
      });
    });

    updateProgress(); // 初始化显示 0/10

    // ---------------------- 播放逻辑 ----------------------
    let isMouseDown = false;
    let isTouching = false;
    let lastTouchedCell = null;

    function playSound(cell) {
      const soundId = cell.getAttribute('data-sound');
      const audioElement = document.getElementById(`sound-${soundId}`);
      
      if (audioElement) {
        audioElement.currentTime = 0;
        audioElement.play().catch(error => console.error('播放失败:', error));
        cell.classList.add('active');
        setTimeout(() => cell.classList.remove('active'), 200);
      }
    }

    // 鼠标事件
    document.addEventListener('mousedown', (e) => {
      isMouseDown = true;
      if (e.target.classList.contains('grid-cell')) playSound(e.target);
    });
    document.addEventListener('mouseup', () => isMouseDown = false);
    document.addEventListener('mouseleave', () => isMouseDown = false);
    gridCells.forEach(cell => {
      cell.addEventListener('click', () => playSound(cell));
      cell.addEventListener('mouseenter', () => {
        if (isMouseDown) playSound(cell);
      });
    });

    // 触屏事件
    document.addEventListener('touchstart', (e) => {
      e.preventDefault();
      isTouching = true;
      const touch = e.touches[0];
      const touchedElement = document.elementFromPoint(touch.clientX, touch.clientY);
      if (touchedElement?.classList.contains('grid-cell')) {
        lastTouchedCell = touchedElement;
        playSound(touchedElement);
      }
    }, { passive: false });

    document.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!isTouching) return;
      const touch = e.touches[0];
      const touchedElement = document.elementFromPoint(touch.clientX, touch.clientY);
      if (touchedElement?.classList.contains('grid-cell') && touchedElement !== lastTouchedCell) {
        lastTouchedCell = touchedElement;
        playSound(touchedElement);
      }
    }, { passive: false });

    document.addEventListener('touchend', () => {
      isTouching = false;
      lastTouchedCell = null;
    });
    document.addEventListener('touchcancel', () => {
      isTouching = false;
      lastTouchedCell = null;
    });
  });
</script>
</body>
</html>
